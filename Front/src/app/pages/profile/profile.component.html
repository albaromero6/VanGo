<div class="profile__container">

    <!-- Cargando -->
    <div class="profile__loading" *ngIf="isLoading">
        <div class="profile__spinner"></div>
        <p>Cargando perfil...</p>
    </div>

    <!-- Error -->
    <div class="profile__error" *ngIf="error">
        <span class="profile__error-icon">&#9888;</span>
        <p>{{ error }}</p>
    </div>

    <div class="profile__grid" *ngIf="!isLoading && !error">

        <!-- Perfil -->
        <div class="profile__section">
            <div class="profile__section-header">
                <h2>Perfil</h2>
                <button class="profile__button-edit" (click)="toggleEdit('personal')"
                    [attr.aria-label]="isEditingPersonal ? 'Cancelar edición' : 'Editar información personal'">
                    <img [src]="isEditingPersonal ? 'assets/img/Cruz.png' : 'assets/img/Lapiz.png'"
                        [alt]="isEditingPersonal ? 'Cancelar' : 'Editar'" class="profile__icon-edit"
                        [ngClass]="{ 'profile__icon-edit--cruz': isEditingPersonal }" />
                </button>
            </div>
            <div class="profile__info-display" *ngIf="!isEditingPersonal">
                <div class="profile__info-item">
                    <span class="profile__info-label">Nombre:</span>
                    <span class="profile__info-value">{{ personalInfo.nombre }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">Apellido:</span>
                    <span class="profile__info-value">{{ personalInfo.apellido }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">Email:</span>
                    <span class="profile__info-value">{{ personalInfo.email }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">Teléfono:</span>
                    <span class="profile__info-value">{{ personalInfo.telefono }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">DNI:</span>
                    <span class="profile__info-value">{{ personalInfo.dni }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">Fecha de nacimiento:</span>
                    <span class="profile__info-value">{{ formatFechaEuropea(personalInfo.fechaNacimiento) }}</span>
                </div>
                <div class="profile__info-item">
                    <span class="profile__info-label">Dirección:</span>
                    <span class="profile__info-value">{{ personalInfo.direccion }}</span>
                </div>
            </div>
            <form (ngSubmit)="savePersonalInfo()" *ngIf="isEditingPersonal">
                <div class="profile__form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" class="profile__form-input" [(ngModel)]="personalInfo.nombre"
                        name="nombre" required [disabled]="isLoading"
                        [ngClass]="{'profile__form-input--error': fieldErrors['nombre']}"
                        (input)="onTextChange('nombre', $event)">
                    <span class="profile__error-message" *ngIf="fieldErrors['nombre']">{{ fieldErrors['nombre']
                        }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="apellido">Apellido</label>
                    <input type="text" id="apellido" class="profile__form-input" [(ngModel)]="personalInfo.apellido"
                        name="apellido" required [disabled]="isLoading"
                        [ngClass]="{'profile__form-input--error': fieldErrors['apellido']}"
                        (input)="onTextChange('apellido', $event)">
                    <span class="profile__error-message" *ngIf="fieldErrors['apellido']">{{ fieldErrors['apellido']
                        }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="profile__form-input" [(ngModel)]="personalInfo.email"
                        name="email" required [disabled]="isLoading"
                        [ngClass]="{'profile__form-input--error': fieldErrors['email']}">
                    <span class="profile__error-message" *ngIf="fieldErrors['email']">{{ fieldErrors['email'] }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="telefono">Teléfono</label>
                    <input type="tel" id="telefono" class="profile__form-input" [(ngModel)]="personalInfo.telefono"
                        name="telefono" required [disabled]="isLoading"
                        [ngClass]="{'profile__form-input--error': fieldErrors['telefono']}">
                    <span class="profile__error-message" *ngIf="fieldErrors['telefono']">{{ fieldErrors['telefono']
                        }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="dni">DNI</label>
                    <input type="text" id="dni" class="profile__form-input" [(ngModel)]="personalInfo.dni" name="dni"
                        required [disabled]="isLoading" [ngClass]="{'profile__form-input--error': fieldErrors['dni']}">
                    <span class="profile__error-message" *ngIf="fieldErrors['dni']">{{ fieldErrors['dni'] }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="fechaNacimiento">Fecha de Nacimiento</label>
                    <input type="date" id="fechaNacimiento" class="profile__form-input" [value]="fechaNacimientoInput"
                        (change)="onFechaNacimientoChange($event)" name="fechaNacimiento" [disabled]="isLoading"
                        [max]="fechaMinima" [min]="fechaMaxima"
                        [ngClass]="{'profile__form-input--error': fieldErrors['fechaNacimiento']}">
                    <span class="profile__error-message" *ngIf="fieldErrors['fechaNacimiento']">{{
                        fieldErrors['fechaNacimiento'] }}</span>
                </div>
                <div class="profile__form-group">
                    <label for="direccion">Dirección</label>
                    <input type="text" id="direccion" class="profile__form-input" [(ngModel)]="personalInfo.direccion"
                        name="direccion" [disabled]="isLoading"
                        [ngClass]="{'profile__form-input--error': fieldErrors['direccion']}">
                    <span class="profile__error-message" *ngIf="fieldErrors['direccion']">{{ fieldErrors['direccion']
                        }}</span>
                </div>
                <button type="submit" class="profile__button-save" [disabled]="isLoading">
                    {{ isLoading ? 'Guardando...' : 'Guardar Cambios' }}
                </button>
            </form>
        </div>

        <!-- Reservas -->
        <div class="profile__section" *ngIf="isClient">
            <div class="profile__section-header">
                <h2>Reservas</h2>
            </div>
            <!-- Reservas en curso primero -->
            <div class="profile__reservations" *ngIf="reservasEnCurso.length > 0">
                <div class="profile__reservation" *ngFor="let reserva of reservasEnCurso">
                    <div class="profile__reservation-header">
                        <h3>{{ reserva.camper }}</h3>
                        <span class="profile__reservations-status"
                            [ngClass]="'profile__reservations-status--' + (reserva.estado === 'CURSO' ? 'en-curso' : reserva.estado.toLowerCase())">
                            {{ reserva.estado === 'CURSO' ? 'EN CURSO' : reserva.estado }}
                        </span>
                    </div>
                    <div class="profile__reservation-details">
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Inicio</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.inicio) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Fin</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.fin) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Salida</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Salid.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Llegada</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Lleg.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Total</label>
                            <span class="profile__reservation-value">{{ reserva.total }} €</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Reservas reservadas -->
            <div class="profile__reservations" *ngIf="reservasReservadas.length > 0">
                <div class="profile__reservation" *ngFor="let reserva of reservasReservadas">
                    <div class="profile__reservation-header">
                        <h3>{{ reserva.camper }}</h3>
                        <span class="profile__reservations-status"
                            [ngClass]="'profile__reservations-status--' + (reserva.estado === 'CURSO' ? 'en-curso' : reserva.estado.toLowerCase())">
                            {{ reserva.estado === 'CURSO' ? 'EN CURSO' : reserva.estado }}
                        </span>
                    </div>
                    <div class="profile__reservation-details">
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Inicio</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.inicio) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Fin</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.fin) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Salida</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Salid.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Llegada</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Lleg.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Total</label>
                            <span class="profile__reservation-value">{{ reserva.total }} €</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Reservas finalizadas -->
            <div class="profile__reservations" *ngIf="reservasFinalizadas.length > 0">
                <div class="profile__reservation" *ngFor="let reserva of reservasFinalizadas">
                    <div class="profile__reservation-header">
                        <h3>{{ reserva.camper }}</h3>
                        <span class="profile__reservations-status"
                            [ngClass]="'profile__reservations-status--' + (reserva.estado === 'CURSO' ? 'en-curso' : reserva.estado.toLowerCase())">
                            {{ reserva.estado === 'CURSO' ? 'EN CURSO' : reserva.estado }}
                        </span>
                    </div>
                    <div class="profile__reservation-details">
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Inicio</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.inicio) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Fin</label>
                            <span class="profile__reservation-value">{{ formatFechaEuropea(reserva.fin) }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Salida</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Salid.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Llegada</label>
                            <span class="profile__reservation-value">{{ reserva.idSed_Lleg.ciudad }}</span>
                        </div>
                        <div class="profile__reservation-detail">
                            <label class="profile__reservation-label">Total</label>
                            <span class="profile__reservation-value">{{ reserva.total }} €</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="profile__reservations-empty"
                *ngIf="reservasEnCurso.length === 0 && reservasReservadas.length === 0 && reservasFinalizadas.length === 0">
                <p>¡Empieza tu aventura!</p>
            </div>
        </div>

        <!-- Eliminar -->
        <div class="profile__section profile__section--danger">
            <div class="profile__danger-content">
                <p>Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor, ten cuidado.</p>
                <button class="profile__button-delete" (click)="deleteAccount()">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <div *ngIf="alertMessage" class="profile__alert" [ngClass]="'profile__alert--' + alertType">
        {{ alertMessage }}
    </div>
</div>